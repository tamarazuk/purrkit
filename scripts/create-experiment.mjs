import { mkdir, writeFile, access } from 'node:fs/promises'
import path from 'node:path'

const args = process.argv.slice(2)
const name = args.find((arg) => !arg.startsWith('-'))
const isActive = args.includes('--active')
const isScratch = args.includes('--scratch') || !isActive
const templateArg = args.find((arg) => arg.startsWith('--template='))
const template = templateArg ? templateArg.split('=')[1] : 'package'
const isNextTemplate = template === 'next' || template === 'next-tailwind'
const isTailwindTemplate = template === 'next-tailwind'

if (!name) {
  console.error(
    'Usage: pnpm experiment:new <name> [--active | --scratch] [--template=package|next|next-tailwind]\n\nExamples:\n  pnpm experiment:new cms-prototype --scratch\n  pnpm experiment:new cms-v2 --active\n  pnpm experiment:new landing-page --active --template=next\n  pnpm experiment:new landing-page --active --template=next-tailwind'
  )
  process.exit(1)
}

const slug = name
  .toLowerCase()
  .replace(/[^a-z0-9-]+/g, '-')
  .replace(/^-+|-+$/g, '')

if (!slug) {
  console.error('Error: experiment name must include letters or numbers.')
  process.exit(1)
}

const repoRoot = process.cwd()
const targetRoot = path.join(
  repoRoot,
  'experiments',
  isScratch ? 'scratch' : 'active',
  slug
)

try {
  await access(targetRoot)
  console.error(`Error: ${targetRoot} already exists.`)
  process.exit(1)
} catch {
  // Continue when directory does not exist.
}

if (isNextTemplate) {
  await mkdir(path.join(targetRoot, 'app'), { recursive: true })
} else {
  await mkdir(path.join(targetRoot, 'src'), { recursive: true })
}

const packageJson = {
  name: `@purrkit/exp-${slug}`,
  private: true,
  type: 'module',
  scripts: isScratch
    ? isNextTemplate
      ? {
          'scratch:dev': 'next dev --port 3075',
          'scratch:build': 'next build',
          'scratch:start': 'next start',
          'scratch:lint': 'next lint',
          'scratch:check-types': 'next typegen && tsc --noEmit',
        }
      : {
          'scratch:lint': 'eslint . --max-warnings 0',
          'scratch:check-types': 'tsc --noEmit',
        }
    : isNextTemplate
      ? {
          dev: 'next dev --port 3075',
          build: 'next build',
          start: 'next start',
          lint: 'next lint',
          'check-types': 'next typegen && tsc --noEmit',
        }
      : {
          lint: 'eslint . --max-warnings 0',
          'check-types': 'tsc --noEmit',
        },
  dependencies: isNextTemplate
    ? {
        next: '16.1.1',
        react: '19.2.3',
        'react-dom': '19.2.3',
      }
    : undefined,
  devDependencies: isNextTemplate
    ? {
        '@purrkit/eslint-config': 'workspace:*',
        '@purrkit/typescript-config': 'workspace:*',
        '@tailwindcss/postcss': isTailwindTemplate ? '4.1.18' : undefined,
        '@types/node': '25.0.3',
        '@types/react': '19.2.7',
        '@types/react-dom': '19.2.3',
        eslint: '^9.39.2',
        'eslint-config-next': '16.1.1',
        postcss: isTailwindTemplate ? '8.5.0' : undefined,
        tailwindcss: isTailwindTemplate ? '4.1.18' : undefined,
        typescript: '5.9.3',
      }
    : {
        '@purrkit/eslint-config': 'workspace:*',
        '@purrkit/typescript-config': 'workspace:*',
        eslint: '^9.39.2',
        typescript: '5.9.3',
      },
}

const eslintConfig = isNextTemplate
  ? `import { nextJsConfig } from "@purrkit/eslint-config/next-js";

/** @type {import("eslint").Linter.Config[]} */
export default nextJsConfig;
`
  : `import { config as baseConfig } from "@purrkit/eslint-config/base";

/** @type {import("eslint").Linter.Config[]} */
export default baseConfig;
`

const tsconfig = isNextTemplate
  ? {
      extends: '@purrkit/typescript-config/nextjs.json',
      compilerOptions: {
        paths: {
          '@/*': ['./*'],
        },
      },
      include: ['next-env.d.ts', '**/*.ts', '**/*.tsx', '.next/types/**/*.ts'],
      exclude: ['node_modules'],
    }
  : {
      extends: '@purrkit/typescript-config/base.json',
      compilerOptions: {
        rootDir: 'src',
        outDir: 'dist',
      },
      include: ['src/**/*.ts'],
      exclude: ['node_modules', 'dist'],
    }

await writeFile(
  path.join(targetRoot, 'package.json'),
  JSON.stringify(packageJson, null, 2) + '\n'
)
await writeFile(path.join(targetRoot, 'eslint.config.js'), eslintConfig)
await writeFile(
  path.join(targetRoot, 'tsconfig.json'),
  JSON.stringify(tsconfig, null, 2) + '\n'
)
if (isNextTemplate) {
  await writeFile(
    path.join(targetRoot, 'next-env.d.ts'),
    '/// <reference types="next" />\n/// <reference types="next/image-types/global" />\n\n// NOTE: This file is generated by Next.js; do not edit.\n'
  )
  if (isTailwindTemplate) {
    await writeFile(
      path.join(targetRoot, 'postcss.config.mjs'),
      '/** @type {import("postcss-load-config").Config} */\nconst config = {\n  plugins: {\n    "@tailwindcss/postcss": {},\n  },\n};\n\nexport default config;\n'
    )
    await writeFile(
      path.join(targetRoot, 'app', 'globals.css'),
      "@import 'tailwindcss';\n\n:root {\n  --background: oklch(1 0 0);\n  --foreground: oklch(0.145 0 0);\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n}\n\n@layer base {\n  body {\n    @apply bg-background text-foreground;\n  }\n}\n"
    )
  }
  await writeFile(
    path.join(targetRoot, 'app', 'layout.tsx'),
    isTailwindTemplate
      ? 'import type { ReactNode } from "react";\nimport "./globals.css";\n\nexport default function RootLayout({ children }: { children: ReactNode }) {\n  return (\n    <html lang="en">\n      <body>{children}</body>\n    </html>\n  );\n}\n'
      : 'import type { ReactNode } from "react";\n\nexport default function RootLayout({ children }: { children: ReactNode }) {\n  return (\n    <html lang="en">\n      <body>{children}</body>\n    </html>\n  );\n}\n'
  )
  await writeFile(
    path.join(targetRoot, 'app', 'page.tsx'),
    isTailwindTemplate
      ? 'export default function Page() {\n  return (\n    <main className="flex min-h-screen items-center justify-center px-6 py-16 text-center">\n      <div className="max-w-xl space-y-4">\n        <h1 className="text-3xl font-semibold">Experiment ready.</h1>\n        <p className="text-base text-foreground/70">\n          Start building with Tailwind and the App Router.\n        </p>\n      </div>\n    </main>\n  );\n}\n'
      : 'export default function Page() {\n  return <main>Experiment ready.</main>;\n}\n'
  )
} else {
  await writeFile(path.join(targetRoot, 'src', 'index.ts'), 'export {};\n')
}

console.log(`Created experiment at ${path.relative(repoRoot, targetRoot)}`)
